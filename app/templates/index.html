<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <title>{{ title }} - Catálogo</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>
<body>
    <header>
        <h1>Catálogo de Produtos da Academia</h1>
        <nav>
            {% if session.logged_in %}
                <a href="{{ url_for('cadastro') }}">Ir para o Painel de Gestão</a>
                <a href="{{ url_for('logout') }}">Sair (Admin)</a>
            {% else %}
                <a href="{{ url_for('login') }}">Acesso Admin</a>
            {% endif %}
        </nav>
    </header>

    {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
            <div class="container">
            {% for category, message in messages %}
                <div class="flash {{ category }}">{{ message }}</div>
            {% endfor %}
            </div>
        {% endif %}
    {% endwith %}

    <form method="GET" action="{{ url_for('index') }}" class="area-filtros">
        <div class="filtro-grupo">
            <label for="marca-input">Filtrar por Marca</label>
            <input class="filtro-select" list="marcas-list" id="marca-input" name="marca_nome" placeholder="Digite ou selecione uma marca" value="{{ selected_marca or '' }}">
            <datalist id="marcas-list">
                {% for marca in marcas %}
                    <option value="{{ marca.nome }}">
                {% endfor %}
            </datalist>
        </div>
        <div class="filtro-grupo">
            <label for="categoria-input">Filtrar por Categoria</label>
            <input class="filtro-select" list="categorias-list" id="categoria-input" name="categoria_nome" placeholder="Digite ou selecione uma categoria" value="{{ selected_categoria or '' }}">
            <datalist id="categorias-list">
                {% for categoria in categorias %}
                    <option value="{{ categoria.nome }}">
                {% endfor %}
            </datalist>
        </div>
        <div class="filtro-grupo">
            <label>&nbsp;</label>
            <button type="submit" class="filtro-btn">Buscar</button>
        </div>
        <div class="filtro-grupo">
            <label>&nbsp;</label>
            <a href="{{ url_for('index') }}" class="filtro-btn clear-btn">Limpar</a>
        </div>
    </form>

    <div class="area-pesquisa">
        <input type="text" id="pesquisa-nome" onkeyup="filtrarPorNome()" placeholder="Pesquisar pelo nome do produto...">
        <span id="contador-resultados"></span>
    </div>
    
    <main class="catalogo-grid">
        {% if produtos %}
            {% for produto in produtos %}
            <div class="produto-card">
                {% if session.logged_in %}
                <div class="menu-pontinhos" onclick="toggleMenu(event, 'menu-{{ produto.id }}')">&#8942;</div>
                <ul id="menu-{{ produto.id }}" class="menu-dropdown">
                    <li><a href="{{ url_for('editar_produto', produto_id=produto.id) }}">Editar</a></li>
                    <li><a href="#" class="delete" onclick="abrirModalExclusao('{{ produto.id }}', '{{ produto.nome }}')">Excluir</a></li>
                </ul>
                {% endif %}
                <img src="{{ produto.imagem_url or 'https://via.placeholder.com/200' }}" alt="Imagem de {{ produto.nome }}">
                <h2 class="produto-nome">{{ produto.nome }}</h2>
                <button class="copy-btn" onclick="copiarCodigo('{{ produto.codigo }}', this)">
                    Copiar Código ({{ produto.codigo }})
                </button>
            </div>
            {% endfor %}
        {% else %}
            <div class="mensagem-vazio">
                {% if request.args %}
                    <p>Nenhum produto encontrado com os filtros selecionados.</p>
                {% else %}
                    <p>Use os filtros acima ou a busca por nome para iniciar.</p>
                {% endif %}
            </div>
        {% endif %}
    </main>

    {% if session.logged_in %}
    <div id="modal-exclusao" class="modal-overlay">
        <div class="modal-content">
            <h2>Confirmar Exclusão</h2>
            <p>Para excluir o produto <strong id="nome-produto-excluir"></strong>, por favor, insira a senha de administrador.</p>
            <form id="form-exclusao" method="POST" action="">
                <div class="form-group">
                    <label for="senha-modal">Senha de Administrador</label>
                    <input type="password" name="senha_admin" id="senha-modal" required>
                </div>
                <div class="form-group">
                    <button type="submit" class="submit-btn" style="background-color: #dc3545;">Confirmar Exclusão</button>
                    <button type="button" class="filtro-btn clear-btn" onclick="fecharModalExclusao()">Cancelar</button>
                </div>
            </form>
        </div>
    </div>
    {% endif %}

    <script>
        function copiarCodigo(codigo, element) {
            navigator.clipboard.writeText(codigo).then(() => {
                const originalText = element.innerHTML;
                element.innerHTML = 'Copiado!';
                setTimeout(() => {
                    element.innerHTML = originalText;
                }, 1500);
            });
        }
        
        async function filtrarPorNome() {
            const input = document.getElementById('pesquisa-nome');
            const query = input.value.trim();
            const grid = document.querySelector('.catalogo-grid');
            const contador = document.getElementById('contador-resultados');
            const filtrosPrincipaisAtivos = new URLSearchParams(window.location.search).has('marca_nome') || new URLSearchParams(window.location.search).has('categoria_nome');

            if (!query && !filtrosPrincipaisAtivos) {
                grid.innerHTML = '<div class="mensagem-vazio"><p>Use os filtros acima ou a busca por nome para iniciar.</p></div>';
                contador.innerText = "";
                return;
            }

            if (query.length > 2) {
                const response = await fetch(`/search?q=${query}`);
                const produtos = await response.json();
                
                grid.innerHTML = "";
                
                if (produtos.length === 0) {
                    grid.innerHTML = '<div class="mensagem-vazio"><p>Nenhum produto encontrado para sua busca.</p></div>';
                } else {
                    produtos.forEach(produto => {
                        const card = document.createElement('div');
                        card.className = 'produto-card';
                        card.innerHTML = `
                            ${'{{ session.logged_in }}' ? `
                            <div class="menu-pontinhos" onclick="toggleMenu(event, 'menu-${produto.id}')">&#8942;</div>
                            <ul id="menu-${produto.id}" class="menu-dropdown">
                                <li><a href="/editar-produto/${produto.id}">Editar</a></li>
                                <li><a href="#" class="delete" onclick="abrirModalExclusao('${produto.id}', '${produto.nome}')">Excluir</a></li>
                            </ul>` : ''}
                            <img src="${produto.imagem_url || 'https://via.placeholder.com/200'}" alt="Imagem de ${produto.nome}">
                            <h2 class="produto-nome">${produto.nome}</h2>
                            <button class="copy-btn" onclick="copiarCodigo('${produto.codigo}', this)">
                                Copiar Código (${produto.codigo})
                            </button>
                        `;
                        grid.appendChild(card);
                    });
                }
                contador.innerText = `${produtos.length} resultado(s) encontrado(s)`;
            } else if (!filtrosPrincipaisAtivos) {
                grid.innerHTML = '<div class="mensagem-vazio"><p>Digite pelo menos 3 caracteres para buscar.</p></div>';
                contador.innerText = "";
            }
        }
        
        // --- LÓGICA PARA OS MENUS E MODAL ---
        function toggleMenu(event, menuId) {
            event.stopPropagation();
            closeAllMenus();
            document.getElementById(menuId).classList.toggle('show');
        }

        function closeAllMenus() {
            document.querySelectorAll('.menu-dropdown').forEach(menu => menu.classList.remove('show'));
        }

        window.onclick = function(event) {
            if (!event.target.matches('.menu-pontinhos')) {
                closeAllMenus();
            }
        }

        const modal = document.getElementById('modal-exclusao');
        const formExclusao = document.getElementById('form-exclusao');
        const nomeProdutoExcluir = document.getElementById('nome-produto-excluir');

        function abrirModalExclusao(produtoId, produtoNome) {
            if(formExclusao) {
                formExclusao.action = `/excluir-produto/${produtoId}`;
                nomeProdutoExcluir.innerText = produtoNome;
                modal.classList.add('show');
            }
        }

        function fecharModalExclusao() {
            if(modal) {
                modal.classList.remove('show');
            }
        }
    </script>
</body>
</html>